@model WebDiaryApp.Models.DiaryEntry

<h1 class="mb-3">新規日記作成</h1>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label class="form-label">タイトル</label>
        <input class="form-control" name="Title" placeholder="タイトルを入力" />
    </div>

    <div class="mb-3">
        <label class="form-label">内容</label>
        <textarea class="form-control" name="Content" rows="6" placeholder="内容を入力"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">カテゴリ</label>
        <input class="form-control" name="Category" placeholder="カテゴリを入力" />
    </div>

    <!-- 🖼️ 画像アップロード欄 -->
    <div class="mb-3">
        <label class="form-label">画像を選択（任意）</label>
        <div class="input-group">
            <input type="file" id="imageUpload" class="form-control" accept="image/*" />
            <button type="button" id="uploadButton" class="btn btn-outline-primary">アップロード</button>
            <!-- 📸 カメラ起動ボタン -->
            <button type="button" id="cameraButton" class="btn btn-outline-secondary">
                <i class="bi bi-camera-fill"></i>
            </button>
            <input type="file" id="cameraInput" accept="image/*" capture="@("camera")" style="display:none;" />
        </div>
        <div class="mt-2">
            <img id="preview" src="" alt="プレビュー" style="max-width:300px; display:none; border:1px solid #ccc; border-radius:8px;" />
        </div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">登録</button>
        <a class="btn btn-secondary" asp-action="Index">キャンセル</a>
    </div>
</form>

@section Scripts {
    <script>
        // ✅ アップロードボタン押下
        document.getElementById("uploadButton").addEventListener("click", async () => {
            const fileInput = document.getElementById("imageUpload");
            const file = fileInput.files[0];
            if (!file) {
                alert("画像を選択してください。");
                return;
            }

            try {
                const imageUrl = await uploadImage(file); // ← 共通関数呼び出し
                applyPreviewAndHidden(imageUrl);
                alert("アップロード成功！");
            } catch (err) {
                alert("アップロードに失敗しました: " + err.message);
            }
        });

        // 📸 カメラ起動ボタン押下
        document.getElementById("cameraButton").addEventListener("click", () => {
            document.getElementById("cameraInput").click();
        });

        // 📸 撮影完了後アップロード
        document.getElementById("cameraInput").addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const imageUrl = await uploadImage(file); // ← 共通関数呼び出し
                applyPreviewAndHidden(imageUrl);
                alert("📸 撮影画像をアップロードしました！");
            } catch (err) {
                alert("アップロードに失敗しました: " + err.message);
            }
        });

        // ✅ プレビュー表示と hidden input の更新
        function applyPreviewAndHidden(imageUrl) {
            const preview = document.getElementById("preview");
            preview.src = imageUrl;
            preview.style.display = "block";

            // form要素を確実に取得
            const form = document.querySelector('form[action$="/Diary/Create"]');
            if (!form) {
                alert("フォームが見つかりません。");
                return;
            }

            let hiddenInput = form.querySelector('input[name="ImageUrl"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "ImageUrl";
                form.appendChild(hiddenInput);
            }
            hiddenInput.value = imageUrl;
            console.log("✅ Hidden input set:", hiddenInput.value);
        }
    </script>
}
