@model WebDiaryApp.Models.DiaryEntry

<h1 class="mb-3">日記を編集</h1>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Id" value="@Model.Id" />
    <input type="hidden" name="ImageUrl" value="@Model.ImageUrl" />

    <div class="mb-3">
        <label class="form-label">タイトル</label>
        <input class="form-control" name="Title" value="@Model.Title" required />
    </div>

    <div class="mb-3">
        <label class="form-label">画像</label><br />
        <div id="imageContainer" class="text-center mb-2">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" class="img-thumbnail mb-2" style="max-width:150px; max-height:150px; object-fit:cover;" />
                <div>
                    <button type="button" id="deleteImageBtn" class="btn btn-outline-danger btn-sm">画像削除</button>
                </div>
            }
        </div>

        <div class="input-group mt-2">
            <input type="file" class="form-control imageUpload" accept="image/*" />
            <button type="button" class="btn btn-outline-primary uploadButton">画像アップロード</button>
            <!-- 📸 カメラ起動ボタン -->
            <button type="button" id="cameraButton" class="btn btn-outline-secondary">
                <i class="bi bi-camera-fill"></i>
            </button>
            <input type="file" id="cameraInput" accept="image/*" capture="@("camera")" style="display:none;" />
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">本文</label>
        <textarea class="form-control" name="Content" rows="5">@Model.Content</textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">カテゴリ</label>
        <input class="form-control" name="Category" value="@Model.Category" />
    </div>

    <button type="submit" class="btn btn-primary">更新</button>
    <a asp-action="Index" class="btn btn-secondary ms-2">戻る</a>
</form>

@section Scripts {
    <script>
        // ✅ アップロード処理（共通化）
        $(document).on('click', '.uploadButton', async function () {
            const fileInput = document.querySelector('.imageUpload');
            const file = fileInput.files[0];
            if (!file) return alert("画像を選択してください。");

            try {
                const imageUrl = await uploadImage(file); // ← 共通関数呼び出し
                applyImagePreview(imageUrl);
                alert("画像をアップロードしました！");
            } catch (err) {
                alert("アップロード失敗: " + err.message);
            }
        });

        // 📸 カメラ撮影からアップロード
        $('#cameraButton').on('click', () => $('#cameraInput').click());
        $('#cameraInput').on('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const imageUrl = await uploadImage(file); // ← 共通関数呼び出し
                applyImagePreview(imageUrl);
                alert("📸 撮影画像をアップロードしました！");
            } catch (err) {
                alert("アップロード失敗: " + err.message);
            }
        });

        // ✅ プレビュー更新＋hidden更新処理を共通化
        function applyImagePreview(imageUrl) {
            // hidden input更新
            let hidden = $('input[name="ImageUrl"]');
            if (!hidden.length) {
                hidden = $('<input>').attr({ type: 'hidden', name: 'ImageUrl' }).appendTo('form');
            }
            hidden.val(imageUrl);

            // プレビュー表示
            $('#imageContainer').html(`
                <img src="${imageUrl}" class="img-thumbnail mb-2" style="max-width:150px; max-height:150px; object-fit:cover;" />
                <div><button type="button" id="deleteImageBtn" class="btn btn-outline-danger btn-sm">画像削除</button></div>
            `);
        }

        // ✅ 画像削除（非同期）
        $(document).on('click', '#deleteImageBtn', async function () {
            if (!confirm("画像を削除しますか？")) return;

            const id = $('input[name="Id"]').val();
            const token = $('input[name="__RequestVerificationToken"]').val();

            const response = await fetch(`/Diary/DeleteImage/${id}`, {
                method: "POST",
                headers: { "RequestVerificationToken": token }
            });

            if (response.ok) {
                $('#imageContainer').html('');
                $('input[name="ImageUrl"]').val("");
                alert("画像を削除しました！");
            } else {
                alert("削除に失敗しました。");
            }
        });

        // ✅ 編集ページ：外クリックで戻る（確認モーダル付き）
        $(document).on('click', function (e) {
            if ($(e.target).closest('form, .modal, .btn').length > 0) return;

            const orig = {
                title: $('input[name="Title"]').attr('data-orig') ?? $('input[name="Title"]').val(),
                content: $('textarea[name="Content"]').attr('data-orig') ?? $('textarea[name="Content"]').val(),
                category: $('input[name="Category"]').attr('data-orig') ?? $('input[name="Category"]').val(),
                image: $('input[name="ImageUrl"]').attr('data-orig') ?? $('input[name="ImageUrl"]').val()
            };
            const now = {
                title: $('input[name="Title"]').val(),
                content: $('textarea[name="Content"]').val(),
                category: $('input[name="Category"]').val(),
                image: $('input[name="ImageUrl"]').val()
            };
            const changed = Object.keys(orig).some(k => orig[k] !== now[k]);

            if (changed) {
                setTimeout(() => {
                    const modalEl = document.getElementById('leaveConfirmModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                }, 50);
            } else {
                window.location.href = '/Diary/Index';
            }
        });

        // ✅ モーダル確定で戻る
        $(document).on('click', '#confirmLeave', () => window.location.href = '/Diary/Index');

        // ✅ 自動でフラッシュメッセージをフェードアウト
        setTimeout(() => $('.alert').fadeOut('slow'), 3000);
    </script>
}
