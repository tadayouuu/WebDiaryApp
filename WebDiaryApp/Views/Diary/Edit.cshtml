@model WebDiaryApp.Models.DiaryEntry

<h1 class="mb-3">日記を編集</h1>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Id" value="@Model.Id" />
    <input type="hidden" name="ImageUrl" value="@Model.ImageUrl" />

    <div class="mb-3">
        <label class="form-label">タイトル</label>
        <input class="form-control" name="Title" value="@Model.Title" required />
    </div>

    <div class="mb-3">
        <label class="form-label">画像</label><br />
        <div id="imageContainer" class="text-center mb-2">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" class="img-thumbnail mb-2" style="max-width:150px; max-height:150px; object-fit:cover;" />
                <div>
                    <button type="button" id="deleteImageBtn" class="btn btn-outline-danger btn-sm">画像削除</button>
                </div>
            }
        </div>

        <div class="input-group mt-2">
            <input type="file" class="form-control imageUpload" accept="image/*" />
            <button type="button" class="btn btn-outline-primary uploadButton">画像アップロード</button>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">本文</label>
        <textarea class="form-control" name="Content" rows="5">@Model.Content</textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">カテゴリ</label>
        <input class="form-control" name="Category" value="@Model.Category" />
    </div>

    <button type="submit" class="btn btn-primary">更新</button>
    <a asp-action="Index" class="btn btn-secondary ms-2">戻る</a>
</form>

<!-- 🪶 編集解除確認モーダル（Scriptsの外） -->
<div class="modal fade" id="leaveConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark">編集を終了しますか？</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-start">
                <p>保存していない変更があります。<br>編集を終了して一覧に戻りますか？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">続ける</button>
                <button type="button" id="confirmLeave" class="btn btn-warning">終了して戻る</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ✅ 画像アップロード処理
        $(document).on('click', '.uploadButton', async function () {
            const fileInput = document.querySelector('.imageUpload');
            const file = fileInput.files[0];
            if (!file) return alert("画像を選択してください。");

            try {
                const imageUrl = await uploadImage(file);

                // hidden inputに反映
                let hidden = $('input[name="ImageUrl"]');
                if (!hidden.length) {
                    hidden = $('<input>').attr({ type: 'hidden', name: 'ImageUrl' }).appendTo('form');
                }
                hidden.val(imageUrl);

                // プレビュー更新
                $('#imageContainer').html(`
                    <img src="${imageUrl}" class="img-thumbnail mb-2" style="max-width:150px; max-height:150px; object-fit:cover;" />
                    <div><button type="button" id="deleteImageBtn" class="btn btn-outline-danger btn-sm">画像削除</button></div>
                `);

                alert("画像をアップロードしました！");
            } catch (err) {
                alert("アップロード失敗: " + err.message);
            }
        });

        // ✅ Supabaseへアップロード
        async function uploadImage(file) {
            const maxWidth = 1200, maxHeight = 1200, quality = 0.8;
            const img = await loadImage(file);
            const canvas = document.createElement("canvas");
            let { width, height } = img;

            if (width > maxWidth || height > maxHeight) {
                const scale = Math.min(maxWidth / width, maxHeight / height);
                width = Math.round(width * scale);
                height = Math.round(height * scale);
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            const blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", quality));
            const formData = new FormData();
            formData.append("file", new File([blob], file.name.replace(/\.[^.]+$/, ".jpg"), { type: "image/jpeg" }));

            const response = await fetch("/Diary/UploadImage", { method: "POST", body: formData });
            if (!response.ok) throw new Error(await response.text());
            const result = await response.json();
            return result.imageUrl;
        }

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // ✅ 画像削除（非同期）
        $(document).on('click', '#deleteImageBtn', async function () {
            if (!confirm("画像を削除しますか？")) return;

            const id = $('input[name="Id"]').val();
            const token = $('input[name="__RequestVerificationToken"]').val();

            const response = await fetch(`/Diary/DeleteImage/${id}`, {
                method: "POST",
                headers: { "RequestVerificationToken": token }
            });

            if (response.ok) {
                $('#imageContainer').html('');
                $('input[name="ImageUrl"]').val("");
                alert("画像を削除しました！");
            } else {
                alert("削除に失敗しました。");
            }
        });

        // ✅ 編集ページ：外クリックで戻る（確認モーダル付き）
        $(document).on('click', function (e) {
            // フォーム内 or モーダルクリックは無視
            if ($(e.target).closest('form, .modal, .btn').length > 0) return;

            // 変更検出
            const orig = {
                title: $('input[name="Title"]').attr('data-orig') ?? $('input[name="Title"]').val(),
                content: $('textarea[name="Content"]').attr('data-orig') ?? $('textarea[name="Content"]').val(),
                category: $('input[name="Category"]').attr('data-orig') ?? $('input[name="Category"]').val(),
                image: $('input[name="ImageUrl"]').attr('data-orig') ?? $('input[name="ImageUrl"]').val()
            };
            const now = {
                title: $('input[name="Title"]').val(),
                content: $('textarea[name="Content"]').val(),
                category: $('input[name="Category"]').val(),
                image: $('input[name="ImageUrl"]').val()
            };
            const changed = Object.keys(orig).some(k => orig[k] !== now[k]);

            if (changed) {
                // モーダルを後から確実に表示
                setTimeout(() => {
                    const modalEl = document.getElementById('leaveConfirmModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                }, 50);
            } else {
                window.location.href = '/Diary/Index';
            }
        });

        // ✅ モーダル確定で戻る
        $(document).on('click', '#confirmLeave', () => window.location.href = '/Diary/Index');

        // ✅ デバッグ（Consoleで確認）
        $('#leaveConfirmModal').on('show.bs.modal', () => console.log('🟡 モーダル表示OK'));

        setTimeout(() => $('.alert').fadeOut('slow'), 3000);
    </script>
}