@model IEnumerable<WebDiaryApp.Models.DiaryEntry>

<h1 class="mb-3">日記一覧</h1>

<!-- 📅 カレンダー -->
<div class="mb-4 input-group" style="max-width: 320px;">
    <input type="text" id="calendarPicker" class="form-control" placeholder="日付を選択（または月を選択）" />
    <button type="button" id="clearDateBtn" class="btn btn-outline-secondary">
        <i class="bi bi-x-circle"></i>
    </button>
</div>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<a class="btn btn-success mb-3" asp-action="Create">新規作成</a>

@if (!string.IsNullOrEmpty(ViewBag.SelectedCategory as string))
{
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary mb-3">すべて表示</a>
}

<div class="row row-cols-1 g-3">
    @foreach (var item in Model.OrderByDescending(d => d.CreatedAt))
    {
        var jst = TimeZoneInfo.FindSystemTimeZoneById("Tokyo Standard Time");
        var createdAtJst = TimeZoneInfo.ConvertTimeFromUtc(item.CreatedAt, jst);

        <div class="col">
            <div class="card shadow-sm diary-card" data-id="@item.Id" style="cursor:pointer;">
                <div class="card-body">
                    <h5 class="card-title">@item.Title</h5>

                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-2">
                            <img src="@item.ImageUrl" class="img-thumbnail"
                                 style="max-width:120px; max-height:120px; object-fit:cover;" />
                        </div>
                    }

                    <p class="card-text text-truncate">@item.Content</p>

                    <button type="button"
                            class="btn btn-outline-secondary btn-sm preview-btn"
                            data-content="@item.Content"
                            data-image="@item.ImageUrl"
                            data-title="@item.Title">
                        <i class="bi bi-eye"></i> プレビュー
                    </button>

                    <div class="badge bg-secondary category-filter" data-category="@item.Category">
                        @item.Category
                    </div>

                    <small class="text-muted d-block text-end">
                        @createdAtJst.ToString("yyyy-MM-dd HH:mm")
                    </small>

                    <div class="mt-2 d-flex gap-2">
                        <form asp-action="Delete" method="post"
                              onsubmit="return confirm('本当に削除しますか？');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@item.Id" />
                            <button type="submit" class="btn btn-danger btn-sm">削除</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- 🪶 プレビュー用モーダル -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header border-0 bg-dark text-white">
                <h5 class="modal-title" id="previewTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="previewBody" style="max-height:70vh; overflow-y:auto;">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Flatpickr 読み込み -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    @{
        var entryDatesJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.EntryDates ?? new List<string>());
    }

    <script>
        // ★ diary-dot を正しく描き直す関数（←ここ）
        function refreshDiaryDots(fp) {
            // カレンダー内のポッチを全消し
            fp.calendarContainer
              .querySelectorAll(".diary-dot")
              .forEach(d => d.remove());

            // entryDates に基づいて付け直す
            fp.days.childNodes.forEach(dayElem => {
                if (!dayElem.dateObj) return;

                const dateStr = fp.formatDate(dayElem.dateObj, "Y-m-d");
                if (entryDates.includes(dateStr)) {
                    const dot = document.createElement("span");
                    dot.className = "diary-dot";
                    dayElem.appendChild(dot);
                }
            });
        }

        $(function () {
            // ✅ カードクリック → 編集画面へ
            $('.diary-card').on('click', function (e) {
                if ($(e.target).closest('form, .btn, .category-filter').length) return;
                const id = $(this).data('id');
                window.location.href = `/Diary/Edit/${id}`;
            });

            // ✅ プレビュー
            $('.preview-btn').on('click', function (e) {
                e.stopPropagation();
                const content = $(this).data('content');
                const image = $(this).data('image');
                const title = $(this).data('title');

                let html = '';
                if (image) {
                    html += `
                        <div class="text-center mb-3">
                            <img src="${image}" class="img-fluid rounded shadow-sm" style="max-width:100%; height:auto;">
                        </div>`;
                }
                html += `<div class="p-2 text-start" style="white-space:pre-wrap; font-size:1.05rem;">${content}</div>`;

                $('#previewTitle').text(title);
                $('#previewBody').html(html);

                const modalEl = document.getElementById('previewModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            });

            // ✅ カテゴリフィルター
            $('.category-filter').on('click', function(e){
                e.stopPropagation();
                const cat = $(this).data('category');
                window.location.href = `/Diary/Index?category=${encodeURIComponent(cat)}`;
            });

            // ✅ 背景クリックでフィルター解除
            $(document).on('click', function(e){
                if ($(e.target).closest('.diary-card, .category-filter, .modal').length === 0) {
                    const hasCategory = '@(ViewBag.SelectedCategory != null)';
                    if (hasCategory === 'True') {
                        window.location.href = '/Diary/Index';
                    }
                }
            });

            // ✅ アラート自動フェードアウト
            setTimeout(() => $('.alert').fadeOut('slow'), 3000);
        });

        // 📅 投稿のある日（C#→JS変換）
        const entryDates = @Html.Raw(entryDatesJson);

        // ★ 念のため残留ポッチを全消し（保険）
        document.querySelectorAll(".diary-dot").forEach(d => d.remove());

        // 📅 Flatpickr初期化
        // const calendar = flatpickr("#calendarPicker", {
        //     dateFormat: "Y-m-d",
        //     locale: "ja",
        //     disableMobile: true,
        //     defaultDate: "@ViewBag.SelectedDate",
        //     onChange: function(selectedDates, dateStr) {
        //         const category = "@ViewBag.SelectedCategory";

        //         if (dateStr) {
        //             let url = `/Diary/Index?date=${dateStr}`;
        //             if (category) url += `&category=${encodeURIComponent(category)}`;
        //             window.location.href = url;
        //         }
        //     },
        //     onDayCreate: function(dObj, dStr, fp, dayElem) {
        //         ★ セル単位でも保険で消す
        //         const oldDot = dayElem.querySelector(".diary-dot");
        //         if (oldDot) oldDot.remove();

        //         ★ dayセル内に残っとるポッチを全消し（重要）
        //         dayElem.querySelectorAll(".diary-dot").forEach(d => d.remove());

        //         const dateStr = fp.formatDate(dayElem.dateObj, "Y-m-d");
        //         if (entryDates.includes(dateStr)) {
        //             const dot = document.createElement("span");
        //             dot.className = "diary-dot";
        //             dayElem.appendChild(dot);
        //         }
        //     }
        // });
        const calendar = flatpickr("#calendarPicker", {
            dateFormat: "Y-m-d",
            locale: "ja",
            disableMobile: true,
            defaultDate: "@ViewBag.SelectedDate",

            onReady: function (selectedDates, dateStr, fp) {
                refreshDiaryDots(fp);
            },
            onMonthChange: function (selectedDates, dateStr, fp) {
                refreshDiaryDots(fp);
            },
            onYearChange: function (selectedDates, dateStr, fp) {
                refreshDiaryDots(fp);
            },

            onChange: function (selectedDates, dateStr) {
                const category = "@ViewBag.SelectedCategory";
                if (dateStr) {
                    let url = `/Diary/Index?date=${dateStr}`;
                    if (category) url += `&category=${encodeURIComponent(category)}`;
                    window.location.href = url;
                }
            }
        });

        // ❌ クリアボタン動作
        document.getElementById("clearDateBtn").addEventListener("click", function () {
            calendar.clear(); // Flatpickrの選択解除
            const category = "@ViewBag.SelectedCategory";
            let url = `/Diary/Index`;
            if (category) url += `?category=${encodeURIComponent(category)}`;
            window.location.href = url;
        });
    </script>

    <style>
        /* 📅 カレンダーの投稿ポッチ */
        .flatpickr-day {
            position: relative;
        }

            .flatpickr-day .diary-dot {
                position: absolute;
                bottom: 4px;
                left: 50%;
                width: 6px;
                height: 6px;
                background-color: #28a745;
                border-radius: 50%;
                transform: translateX(-50%);
            }
    </style>
}
