@model IEnumerable<WebDiaryApp.Models.DiaryEntry>

<h1 class="mb-3">日記一覧</h1>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<a class="btn btn-success mb-3" asp-action="Create">新規作成</a>

<div class="row row-cols-1 g-3">
    @foreach (var item in Model.OrderByDescending(d => d.CreatedAt))
    {
        var jst = TimeZoneInfo.FindSystemTimeZoneById("Tokyo Standard Time");
        var createdAtJst = TimeZoneInfo.ConvertTimeFromUtc(item.CreatedAt, jst);

        <div class="col">
            <div class="card shadow-sm diary-card" data-id="@item.Id">
                <!-- 表示部分 -->
                <div class="card-body summary">
                    <h5 class="card-title"><span>📝</span> @item.Title</h5>

                    @* 🖼 画像サムネイル（存在する場合のみ） *@
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-2">
                            <img src="@item.ImageUrl"
                                 alt="日記画像サムネ"
                                 class="img-thumbnail"
                                 style="max-width: 120px; max-height: 120px; object-fit: cover;" />
                        </div>
                    }

                    <p class="card-text text-truncate">@item.Content</p>
                    <small class="text-muted d-block text-end" style="font-size:0.8rem;">@createdAtJst.ToString("yyyy-MM-dd HH:mm")</small>
                    <div class="badge bg-secondary mt-1 category-badge" data-category="@item.Category">@item.Category</div>
                </div>

                <!-- 編集フォーム -->
                <div class="card-body edit-form d-none">
                    <form asp-action="Edit" method="post" class="mb-2">
                        <input type="hidden" name="Id" value="@item.Id" />
                        <input class="form-control mb-2" name="Title" value="@item.Title" placeholder="タイトル" />
                        <!-- 現在の画像表示 -->
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <div class="text-center mb-2">
                                <img src="@item.ImageUrl"
                                     alt="現在の画像"
                                     class="img-thumbnail"
                                     style="max-width:120px; max-height:120px; object-fit:cover;" />
                            </div>
                        }

                        <!-- 新しい画像アップロード欄 -->
                        <div class="input-group mb-2">
                            <input type="file" class="form-control imageUpload" accept="image/*" />
                            <button type="button" class="btn btn-outline-primary uploadButton">画像再アップロード</button>
                        </div>

                        <!-- 画像URL保持 -->
                        <input type="hidden" name="ImageUrl" value="@item.ImageUrl" />

                        <textarea class="form-control mb-2" name="Content" rows="4">@item.Content</textarea>
                        <input class="form-control mb-2" name="Category" value="@item.Category" placeholder="カテゴリ" />
                        <small class="text-muted">作成日: @createdAtJst.ToString("yyyy-MM-dd HH:mm")</small>
                        <div class="d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-primary btn-sm">更新</button>
                        </div>
                    </form>

                    <form asp-action="Delete" method="post" onsubmit="return confirm('本当に削除しますか？');">
                        <input type="hidden" name="id" value="@item.Id" />
                        <button type="submit" class="btn btn-danger btn-sm">削除</button>
                    </form>
                </div>

                <!-- プレビュー -->
                <div class="card-body preview-form d-none">
                    <h5 class="card-title"><span>📝</span> @item.Title</h5>

                    @* 🖼️ 画像がある場合だけ表示 *@
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-3">
                            <img src="@item.ImageUrl"
                                 alt="日記画像"
                                 class="img-fluid rounded shadow-sm"
                                 style="max-width: 100%; height: auto;" />
                        </div>
                    }

                    <p>@item.Content</p>
                    <div class="badge bg-secondary mt-1">@item.Category</div>
                    <small class="text-muted">@createdAtJst.ToString("yyyy-MM-dd HH:mm")</small>
                </div>

                <div class="card-body d-flex gap-2 mt-2">
                    <button type="button" class="btn btn-info btn-sm btn-preview">プレビュー</button>
                    @* <button type="button" class="btn btn-primary btn-sm btn-edit">編集</button> *@
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.diary-card').off('click').on('click', function (e) {
                // フォーム内やボタン類は無視
                if (
                    $(e.target).closest('form').length ||
                    $(e.target).hasClass('btn') ||
                    $(e.target).closest('.btn').length
                ) return;

                var $clickedCard = $(this);

                // もしプレビュー中なら、クリックしても編集を開かない
                if (!$clickedCard.find('.preview-form').hasClass('d-none')) {
                    return;
                }

                // 他のカードを閉じる
                $('.diary-card').not($clickedCard).find('.summary').removeClass('d-none');
                $('.diary-card').not($clickedCard).find('.edit-form, .preview-form').addClass('d-none');

                // 自分のカードだけトグル
                $clickedCard.find('.summary').toggleClass('d-none');
                $clickedCard.find('.edit-form').toggleClass('d-none');
            });

            $('.btn-preview').off('click').on('click', function (e) {
                e.stopImmediatePropagation(); // 伝播を完全に止める

                var $card = $(this).closest('.diary-card');

                // 他カード閉じる
                $('.diary-card').not($card).find('.summary').removeClass('d-none');
                $('.diary-card').not($card).find('.edit-form, .preview-form').addClass('d-none');

                // このカードだけプレビュー表示
                $card.find('.summary, .edit-form').addClass('d-none');
                $card.find('.preview-form').removeClass('d-none');
            });

            $('.btn-edit').off('click').on('click', function (e) {
                e.stopImmediatePropagation();

                var $card = $(this).closest('.diary-card');

                // 他カード閉じる
                $('.diary-card').not($card).find('.summary').removeClass('d-none');
                $('.diary-card').not($card).find('.edit-form, .preview-form').addClass('d-none');

                // 自分の編集フォーム開く
                $card.find('.summary, .preview-form').addClass('d-none');
                $card.find('.edit-form').removeClass('d-none');
            });

            // カード外クリックでリセット
            $(document).click(function (e) {
                if ($(e.target).closest('.diary-card').length) return;
                $('.diary-card').find('.summary').removeClass('d-none');
                $('.diary-card').find('.edit-form, .preview-form').addClass('d-none');
            });
            
            $('.category-badge').off('click').on('click', function (e) {
                e.stopPropagation();
                var category = $(this).data('category');
                var isActive = $(this).hasClass('active-category');

                // いったん全解除
                $('.category-badge').removeClass('active-category');

                if (!isActive) {
                    $(this).addClass('active-category');
                    $('.diary-card').each(function () {
                        const cardCategory = $(this).find('.category-badge').data('category');
                        $(this).toggle(cardCategory === category);
                    });
                } else {
                    $('.diary-card').show();
                }
            });

            $(document).on('click', '.uploadButton', async function () {
                const $card = $(this).closest('.diary-card');
                const fileInput = $card.find('.imageUpload')[0];
                const file = fileInput.files[0];
                if (!file) {
                    alert("画像を選択してください。");
                    return;
                }

                const formData = new FormData();
                formData.append("file", file);

                const response = await fetch("/Diary/UploadImage", {
                    method: "POST",
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    // hidden input 更新
                    $card.find('input[name="ImageUrl"]').val(data.imageUrl);
                    // プレビュー画像（既存）も差し替え
                    $card.find('img').first().attr('src', data.imageUrl);
                    alert("画像を更新しました！");
                } else {
                    alert("画像のアップロードに失敗しました。");
                }
            });

            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 3000);
        });
    </script>
}
