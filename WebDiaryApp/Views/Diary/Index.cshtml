@model IEnumerable<WebDiaryApp.Models.DiaryEntry>

<h1 class="mb-3">日記一覧</h1>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<a class="btn btn-success mb-3" asp-action="Create">新規作成</a>

@if (!string.IsNullOrEmpty(ViewBag.SelectedCategory as string))
{
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary mb-3">すべて表示</a>
}

<div class="row row-cols-1 g-3">
    @foreach (var item in Model.OrderByDescending(d => d.CreatedAt))
    {
        var jst = TimeZoneInfo.FindSystemTimeZoneById("Tokyo Standard Time");
        var createdAtJst = TimeZoneInfo.ConvertTimeFromUtc(item.CreatedAt, jst);

        <div class="col">
            <div class="card shadow-sm diary-card" data-id="@item.Id" style="cursor:pointer;">
                <div class="card-body">
                    <h5 class="card-title">@item.Title</h5>

                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-2">
                            <img src="@item.ImageUrl" class="img-thumbnail"
                                 style="max-width:120px; max-height:120px; object-fit:cover;" />
                        </div>
                    }

                    <p class="card-text text-truncate">@item.Content</p>
                    <button type="button"
                            class="btn btn-link p-0 preview-btn"
                            data-content="@item.Content"
                            data-image="@item.ImageUrl">
                        プレビュー
                    </button>

                    <div class="badge bg-secondary category-filter" data-category="@item.Category">
                        @item.Category
                    </div>

                    <small class="text-muted d-block text-end">
                        @createdAtJst.ToString("yyyy-MM-dd HH:mm")
                    </small>

                    <div class="mt-2 d-flex gap-2">
                        <form asp-action="Delete" method="post"
                              onsubmit="return confirm('本当に削除しますか？');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@item.Id" />
                            <button type="submit" class="btn btn-danger btn-sm">削除</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- 🪶 プレビュー用モーダル -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">本文プレビュー</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="previewBody"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // ✅ カードクリック → 編集画面へ
            $('.diary-card').on('click', function (e) {
                if ($(e.target).closest('form, .btn, .category-filter').length) return;
                const id = $(this).data('id');
                window.location.href = `/Diary/Edit/${id}`;
            });

            // ✅ プレビュー（本文＋画像）
            $('.preview-btn').on('click', function (e) {
                e.stopPropagation();
                const content = $(this).data('content');
                const image = $(this).data('image');

                let html = '';
                if (image) {
                    html += `<img src="${image}" class="img-fluid mb-3 rounded" style="max-width:300px;">`;
                }
                html += `<p class="text-start">${content}</p>`;

                $('#previewBody').html(html);
                const modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            });

            // ✅ カテゴリーフィルター
            $('.category-filter').on('click', function(e){
                e.stopPropagation();
                const cat = $(this).data('category');
                window.location.href = `/Diary/Index?category=${encodeURIComponent(cat)}`;
            });

            // ✅ 背景クリックでフィルター解除
            $(document).on('click', function(e){
                if ($(e.target).closest('.diary-card, .category-filter, .modal').length === 0) {
                    const hasCategory = '@(ViewBag.SelectedCategory != null)';
                    if (hasCategory === 'True') {
                        window.location.href = '/Diary/Index';
                    }
                }
            });

            // ✅ アラート自動フェードアウト
            setTimeout(() => $('.alert').fadeOut('slow'), 3000);
        });
    </script>
}
