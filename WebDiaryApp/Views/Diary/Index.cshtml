@model IEnumerable<WebDiaryApp.Models.DiaryEntry>

<h1 class="mb-3">日記一覧</h1>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<a class="btn btn-success mb-3" asp-action="Create">新規作成</a>

<div class="row row-cols-1 g-3">
    @foreach (var item in Model.OrderByDescending(d => d.CreatedAt))
    {
        var jst = TimeZoneInfo.FindSystemTimeZoneById("Tokyo Standard Time");
        var createdAtJst = TimeZoneInfo.ConvertTimeFromUtc(item.CreatedAt, jst);

        <div class="col">
            <div class="card shadow-sm diary-card" data-id="@item.Id">
                <!-- 表示部分 -->
                <div class="card-body summary">
                    <h5 class="card-title"><span>📝</span> @item.Title</h5>

                    @* 🖼 画像サムネイル（存在する場合のみ） *@
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-2">
                            <img src="@item.ImageUrl"
                                 alt="日記画像サムネ"
                                 class="img-thumbnail"
                                 style="max-width: 120px; max-height: 120px; object-fit: cover;" />
                        </div>
                    }

                    <p class="card-text text-truncate">@item.Content</p>
                    <small class="text-muted d-block text-end" style="font-size:0.8rem;">@createdAtJst.ToString("yyyy-MM-dd HH:mm")</small>
                    <div class="badge bg-secondary mt-1 category-badge" data-category="@item.Category">@item.Category</div>
                </div>

                <div class="card-body edit-form d-none">

                    <!-- 編集フォーム -->
                    <form asp-action="Edit" method="post" class="mb-2">
                        <input type="hidden" name="Id" value="@item.Id" />
                        <input class="form-control mb-2" name="Title" value="@item.Title" placeholder="タイトル" />

                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <div class="text-center mb-2 position-relative">
                                <img src="@item.ImageUrl"
                                     alt="現在の画像"
                                     class="img-thumbnail diary-img"
                                     style="max-width:120px; max-height:120px; object-fit:cover;" />

                                <!-- 見た目は画像の右上に浮かせる -->
                                <form asp-action="DeleteImage" asp-route-id="@item.Id"
                                      method="post"
                                      onsubmit="return confirm('画像を削除しますか？');"
                                      class="delete-image-form">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">✖</button>
                                </form>
                            </div>
                        }

                        <div class="input-group mb-2">
                            <input type="file" class="form-control imageUpload" accept="image/*" />
                            <button type="button" class="btn btn-outline-primary uploadButton">画像再アップロード</button>
                        </div>

                        <input type="hidden" name="ImageUrl" value="@item.ImageUrl" />
                        <textarea class="form-control mb-2" name="Content" rows="4">@item.Content</textarea>
                        <input class="form-control mb-2" name="Category" value="@item.Category" placeholder="カテゴリ" />
                        <small class="text-muted">作成日: @createdAtJst.ToString("yyyy-MM-dd HH:mm")</small>

                        <div class="d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-primary btn-sm">更新</button>
                        </div>
                    </form>

                    <!-- 🔻画像削除フォーム（Editの外に出す！） -->
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-2">
                            <form asp-action="DeleteImage" asp-route-id="@item.Id"
                                  method="post"
                                  onsubmit="return confirm('画像を削除しますか？');"
                                  style="display:inline-block;">
                                <button type="submit" class="btn btn-outline-danger btn-sm">画像を削除</button>
                            </form>
                        </div>
                    }

                    <!-- 日記削除フォーム -->
                    <form asp-action="Delete" method="post" onsubmit="return confirm('本当に削除しますか？');">
                        <input type="hidden" name="id" value="@item.Id" />
                        <button type="submit" class="btn btn-danger btn-sm">削除</button>
                    </form>
                </div>

                <!-- プレビュー -->
                <div class="card-body preview-form d-none">
                    <h5 class="card-title"><span>📝</span> @item.Title</h5>

                    @* 🖼️ 画像がある場合だけ表示 *@
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="text-center mb-3">
                            <img src="@item.ImageUrl"
                                 alt="日記画像"
                                 class="img-fluid rounded shadow-sm"
                                 style="max-width: 100%; height: auto;" />
                        </div>
                    }

                    <p>@item.Content</p>
                    <div class="badge bg-secondary mt-1">@item.Category</div>
                    <small class="text-muted">@createdAtJst.ToString("yyyy-MM-dd HH:mm")</small>
                </div>

                <div class="card-body d-flex gap-2 mt-2">
                    <button type="button" class="btn btn-info btn-sm btn-preview">プレビュー</button>
                    @* <button type="button" class="btn btn-primary btn-sm btn-edit">編集</button> *@
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.diary-card').off('click').on('click', function (e) {
                // フォーム内やボタン類は無視
                if (
                    $(e.target).closest('form').length ||
                    $(e.target).hasClass('btn') ||
                    $(e.target).closest('.btn').length
                ) return;

                var $clickedCard = $(this);

                // もしプレビュー中なら、クリックしても編集を開かない
                if (!$clickedCard.find('.preview-form').hasClass('d-none')) {
                    return;
                }

                // 他のカードを閉じる
                $('.diary-card').not($clickedCard).find('.summary').removeClass('d-none');
                $('.diary-card').not($clickedCard).find('.edit-form, .preview-form').addClass('d-none');

                // 自分のカードだけトグル
                $clickedCard.find('.summary').toggleClass('d-none');
                $clickedCard.find('.edit-form').toggleClass('d-none');
            });

            $('.btn-preview').off('click').on('click', function (e) {
                e.stopImmediatePropagation(); // 伝播を完全に止める

                var $card = $(this).closest('.diary-card');

                // 他カード閉じる
                $('.diary-card').not($card).find('.summary').removeClass('d-none');
                $('.diary-card').not($card).find('.edit-form, .preview-form').addClass('d-none');

                // このカードだけプレビュー表示
                $card.find('.summary, .edit-form').addClass('d-none');
                $card.find('.preview-form').removeClass('d-none');
            });

            $('.btn-edit').off('click').on('click', function (e) {
                e.stopImmediatePropagation();

                var $card = $(this).closest('.diary-card');

                // 他カード閉じる
                $('.diary-card').not($card).find('.summary').removeClass('d-none');
                $('.diary-card').not($card).find('.edit-form, .preview-form').addClass('d-none');

                // 自分の編集フォーム開く
                $card.find('.summary, .preview-form').addClass('d-none');
                $card.find('.edit-form').removeClass('d-none');
            });

            // カード外クリックでリセット
            $(document).click(function (e) {
                if ($(e.target).closest('.diary-card').length) return;
                $('.diary-card').find('.summary').removeClass('d-none');
                $('.diary-card').find('.edit-form, .preview-form').addClass('d-none');
            });
            
            $('.category-badge').off('click').on('click', function (e) {
                e.stopPropagation();
                var category = $(this).data('category');
                var isActive = $(this).hasClass('active-category');

                // いったん全解除
                $('.category-badge').removeClass('active-category');

                if (!isActive) {
                    $(this).addClass('active-category');
                    $('.diary-card').each(function () {
                        const cardCategory = $(this).find('.category-badge').data('category');
                        $(this).toggle(cardCategory === category);
                    });
                } else {
                    $('.diary-card').show();
                }
            });

            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 3000);
        });

        $(document).on('click', '.uploadButton', async function () {
            const $card = $(this).closest('.diary-card');
            const fileInput = $card.find('.imageUpload')[0];
            const file = fileInput.files[0];
            if (!file) {
                alert("画像を選択してください。");
                return;
            }

            try {
                const imageUrl = await resizeAndUpload(file);

                // hidden input 更新
                $card.find('input[name="ImageUrl"]').val(imageUrl);

                // ✅ 編集フォーム内の画像更新
                $card.find('.edit-form img').attr('src', imageUrl);

                // ✅ 一覧サムネイル（summary側）も更新
                $card.find('.summary img').attr('src', imageUrl);

                // ✅ プレビュー側も更新
                $card.find('.preview-form img').attr('src', imageUrl);

                // ✅ 軽いアニメーションで「変わった」感
                const $img = $card.find('.summary img');
                $img.fadeOut(100, () => {
                    $img.fadeIn(300).addClass('image-updated');
                    setTimeout(() => $img.removeClass('image-updated'), 800);
                });

                alert("画像を再アップロードしました！");
            } catch (err) {
                alert("アップロードに失敗しました: " + err.message);
            }
        });

        async function resizeAndUpload(file) {
            const maxWidth = 1200;
            const maxHeight = 1200;
            const quality = 0.8;

            // 画像読み込み
            const img = await loadImage(file);

            // Canvasリサイズ
            const canvas = document.createElement("canvas");
            let { width, height } = img;
            if (width > maxWidth || height > maxHeight) {
                const scale = Math.min(maxWidth / width, maxHeight / height);
                width = Math.round(width * scale);
                height = Math.round(height * scale);
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // ✅ JPEG強制出力（画質指定）
            const blob = await new Promise((resolve) =>
                canvas.toBlob(
                    resolve,
                    "image/jpeg", // ← JPEG固定
                    quality // ← 圧縮率指定（0.8 = 約80%品質）
                )
            );

            // ✅ ファイルサイズ確認（デバッグ用）
            console.log("Before:", (file.size / 1024).toFixed(1) + "KB");
            console.log("After:", (blob.size / 1024).toFixed(1) + "KB");

            // アップロード
            const formData = new FormData();
            formData.append("file", new File([blob], file.name.replace(/\.[^.]+$/, ".jpg"), { type: "image/jpeg" }));

            const response = await fetch("/Diary/UploadImage", {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                const text = await response.text();
                throw new Error(text);
            }

            const result = await response.json();
            return result.imageUrl;
        }

        // 📸 EXIF無視で画像読み込み
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
    </script>
}
