@model IEnumerable<WebDiaryApp.Models.DiaryEntry>

<h1 class="mb-3">日記一覧</h1>

@if (TempData["FlashMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["FlashMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<a class="btn btn-success mb-3" asp-action="Create">新規作成</a>

<div class="row row-cols-1 g-3">
    @foreach (var item in Model.OrderByDescending(d => d.Date))
    {
        <div class="col">
            <div class="card shadow-sm diary-card" data-id="@item.Id">
                <!-- 表示部分 -->
                <div class="card-body summary">
                    <h5 class="card-title text-truncate">@item.Title</h5>
                    <p class="card-text text-truncate">@item.Content</p>
                    <small class="text-muted">@item.Date.ToString("yyyy-MM-dd HH:mm")</small>
                    <div class="badge bg-secondary mt-1 tag-badge" data-tag="@item.Tag">@item.Tag</div>
                </div>

                <!-- 編集フォーム -->
                <div class="card-body edit-form d-none">
                    <form asp-action="Edit" method="post" class="mb-2">
                        <input type="hidden" name="Id" value="@item.Id" />
                        <input class="form-control mb-2" name="Title" value="@item.Title" placeholder="タイトル" />
                        <textarea class="form-control mb-2" name="Content" rows="4">@item.Content</textarea>
                        <input class="form-control mb-2" name="Tag" value="@item.Tag" placeholder="タグ" />
                        <small class="text-muted">作成日: @item.Date.ToString("yyyy-MM-dd HH:mm")</small>
                        <div class="d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-primary btn-sm">更新</button>
                        </div>
                    </form>

                    <form asp-action="Delete" method="post" onsubmit="return confirm('本当に削除しますか？');">
                        <input type="hidden" name="id" value="@item.Id" />
                        <button type="submit" class="btn btn-danger btn-sm">削除</button>
                    </form>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.diary-card').click(function (e) {
                if ($(e.target).closest('form').length) return;

                var $clickedCard = $(this);

                // 他のカードを閉じる
                $('.diary-card').not($clickedCard).find('.summary').removeClass('d-none');
                $('.diary-card').not($clickedCard).find('.edit-form').addClass('d-none');

                // クリックしたカードだけ切り替え
                $clickedCard.find('.summary').toggleClass('d-none');
                $clickedCard.find('.edit-form').toggleClass('d-none');
            });

            $(document).click(function (e) {
                if ($(e.target).closest('.diary-card').length) return;

                $('.diary-card').find('.summary').removeClass('d-none');
                $('.diary-card').find('.edit-form').addClass('d-none');
            });

            $('.tag-badge').click(function (e) {
                e.stopPropagation();
                var tag = $(this).data('tag');
                var isActive = $(this).hasClass('active-tag');

                $('.tag-badge').removeClass('active-tag');

                if (!isActive) {
                    $(this).addClass('active-tag');
                    $('.diary-card').each(function () {
                        if ($(this).find('.tag-badge').data('tag') !== tag) {
                            $(this).hide();
                        } else {
                            $(this).show();
                        }
                    });
                } else {
                    $('.diary-card').show();
                }
            });

            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 3000);
        });
    </script>
}
